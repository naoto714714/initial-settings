name: Claude Code Review

on:
  pull_request:
    types: [opened]
    # Optional: Only run on specific file changes
    # paths:
    #   - "src/**/*.ts"
    #   - "src/**/*.tsx"
    #   - "src/**/*.js"
    #   - "src/**/*.jsx"

jobs:
  claude-review:
    # Optional: Filter by PR author
    # if: |
    #   github.event.pull_request.user.login == 'external-contributor' ||
    #   github.event.pull_request.user.login == 'new-developer' ||
    #   github.event.pull_request.author_association == 'FIRST_TIME_CONTRIBUTOR'

    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
      issues: read
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Run Claude Code Review
        id: claude-review
        uses: anthropics/claude-code-action@beta
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}

          # Optional: Specify model (defaults to Claude Sonnet 4, uncomment for Claude Opus 4)
          model: "claude-opus-4-20250514"

          # Direct prompt for automated review (no @claude mention needed)
          direct_prompt: |
            ã“ã®ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆï¼ˆPRï¼‰ã‚’ãƒ¬ãƒ“ãƒ¥ãƒ¼ã—ã€GitHub ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼æ©Ÿèƒ½ã‚’ä½¿ã£ã¦ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’ã—ã¦ãã ã•ã„ã€‚ä½œæ¥­ã¯æ¬¡ã®æ‰‹é †ã«æ²¿ã£ã¦é€²ã‚ã¦ãã ã•ã„ï¼š
            1.  ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’é–‹å§‹ã™ã‚‹: `mcp__github__create_pending_pull_request_review` ã‚’ä½¿ã£ã¦ã€ä¿ç•™ä¸­ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’é–‹å§‹ã—ã¾ã™ã€‚
            2.  å¤‰æ›´å†…å®¹ã‚’ç¢ºèªã™ã‚‹: `mcp__github__get_pull_request_diff` ã‚’ä½¿ã£ã¦ã€ã‚³ãƒ¼ãƒ‰ã®å¤‰æ›´ç‚¹ã‚„è¡Œç•ªå·ã‚’æŠŠæ¡ã—ã¾ã™ã€‚
            3.  ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ã‚³ãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ ã™ã‚‹: æ”¹å–„ç‚¹ã‚„æ‡¸å¿µäº‹é …ãŒã‚ã‚‹ã‚³ãƒ¼ãƒ‰ã®è¡Œã«ã¯ `mcp__github__add_pull_request_review_comment_to_pending_review` ã‚’ä½¿ã£ã¦ã‚³ãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ ã—ã¦ãã ã•ã„ã€‚ä¿®æ­£æ–¹é‡ãŒæ˜ç¢ºãªå ´åˆã«ã¯ç©æ¥µçš„ã«suggestionã‚’åˆ©ç”¨ã—ã¦ãã ã•ã„ã€‚
            4.  ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’æå‡ºã™ã‚‹: `mcp__github__submit_pending_pull_request_review` ã‚’ä½¿ã£ã¦ã€ã‚¤ãƒ™ãƒ³ãƒˆã‚¿ã‚¤ãƒ—ã‚’ã€ŒCOMMENTã€ã«è¨­å®šã—ã€å…¨ä½“ã®ã¾ã¨ã‚ã‚³ãƒ¡ãƒ³ãƒˆã¨å…±ã«ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’æå‡ºã—ã¦ãã ã•ã„ï¼ˆâ€»ã€ŒREQUEST_CHANGESã€ã¯ä½¿ã‚ãªã„ã§ãã ã•ã„ï¼‰ã€‚

            ## ã‚³ãƒ¡ãƒ³ãƒˆã®æ›¸ãæ–¹ã«é–¢ã™ã‚‹é‡è¦äº‹é …

            ### ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ã‚³ãƒ¡ãƒ³ãƒˆã®æ§‹æˆ
                - çµè«–ã‚’å…ˆã«: å„ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ã‚³ãƒ¡ãƒ³ãƒˆã®å†’é ­ã§ã€æŒ‡æ‘˜å†…å®¹ã®è¦ç‚¹ã‚’ä¸€è¡Œã§ç°¡æ½”ã«è¿°ã¹ã¦ãã ã•ã„ã€‚
                - ç†ç”±ã¨ææ¡ˆ: çµè«–ã®å¾Œã«ã€ãã®ã‚ˆã†ã«åˆ¤æ–­ã—ãŸç†ç”±ã‚„èƒŒæ™¯ã€å…·ä½“çš„ãªä¿®æ­£æ¡ˆã‚’è©³ã—ãèª¬æ˜ã—ã¦ãã ã•ã„ã€‚
                - æŒ‡æ‘˜ä¸­å¿ƒã«: ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ã‚³ãƒ¡ãƒ³ãƒˆã¯ã€ä¿®æ­£ææ¡ˆã€ãƒã‚°ã®å¯èƒ½æ€§ã€å¯èª­æ€§ã®å•é¡Œãªã©ã€å…·ä½“çš„ãªæ”¹å–„ç‚¹ã«ç„¦ç‚¹ã‚’å½“ã¦ã¦ãã ã•ã„ã€‚
                - AIç”¨ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’è¨˜è¼‰: AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã«ä¿®æ­£ã‚’ã—ã¦ã‚‚ã‚‰ã†ã‚ˆã†ãªãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ã€ä»¥ä¸‹ã‚’å‚è€ƒã«è¨˜è¼‰ã—ã¦ãã ã•ã„ã€‚
                <details>
                <summary>ğŸ¤– Prompt for AI Agents</summary>

                ```
                `bird-and-beans/js/collision.js` ã® 25 è¡Œç›®ã§ã€static ãƒ¡ã‚½ãƒƒãƒ‰å†…ã§ `this.checkPointInRect` ãŒèª¤ã£ã¦ä½¿ã‚ã‚Œã¦ã„ã¾ã™ã€‚æ­£ã—ã„ static ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã§å‚ç…§ã§ãã‚‹ã‚ˆã†ã«ã€`this` ã‚’ã‚¯ãƒ©ã‚¹åã«ç½®ãæ›ãˆã¦ãã ã•ã„ã€‚
                ```

                </details>

            ### ãƒã‚¸ãƒ†ã‚£ãƒ–ãªãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã«ã¤ã„ã¦
                - ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ã§ã¯æ§ãˆã‚ã«: ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ã§è¨€åŠã™ã‚‹ã®ã¯ã€ç‰¹ã«å„ªã‚ŒãŸè¨­è¨ˆã‚„ä»–ã®é–‹ç™ºè€…ã®å‚è€ƒã«ãªã‚‹ã‚ˆã†ãªç‹¬å‰µçš„ãªå®Ÿè£…ãªã©ã€ç‰¹ç­†ã™ã¹ãç‚¹ã«é™å®šã—ã¾ã™ã€‚
                - ã¾ã¨ã‚ã‚³ãƒ¡ãƒ³ãƒˆã§è¨€åŠ: å…¨ä½“çš„ã«è‰¯ã‹ã£ãŸç‚¹ã‚„ã€PRå…¨ä½“ã«å¯¾ã™ã‚‹ãƒã‚¸ãƒ†ã‚£ãƒ–ãªæ„Ÿæƒ³ã¯ã€ãƒ¬ãƒ“ãƒ¥ãƒ¼æå‡ºæ™‚ã®ã€Œã¾ã¨ã‚ã‚³ãƒ¡ãƒ³ãƒˆã€ã«é›†ç´„ã—ã¦è¨˜è¿°ã—ã¦ãã ã•ã„ã€‚

            ## ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®è¦³ç‚¹

            ãƒ¬ãƒ“ãƒ¥ãƒ¼ã§ã¯ä»¥ä¸‹ã®ç‚¹ã«æ³¨ç›®ã—ã¦ãã ã•ã„ï¼š
            - CLAUDE.mdã®ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³ã«å¾“ã£ã¦ã„ã‚‹ã‹
            - ã‚³ãƒ¼ãƒ‰ã®å“è³ªã‚„ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã«æ²¿ã£ã¦ã„ã‚‹ã‹
            - ãƒã‚°ã‚„ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒªã‚¹ã‚¯ãŒãªã„ã‹
            - ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ä¸Šã®æ‡¸å¿µãŒãªã„ã‹
            - ä¿å®ˆæ€§ã‚„å¯èª­æ€§ã¯ååˆ†ã‹
            - è¨­è¨ˆã‚„ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã«å¦¥å½“æ€§ãŒã‚ã‚‹ã‹

            ## ãã®ä»–

            - æ—¥æœ¬èªã§ã®ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚
            - å…·ä½“çš„ã§å®Ÿè¡Œå¯èƒ½ãªãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚
            - **é‡è¦:** ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®æå‡ºã¯å¿…ãšã€ŒCOMMENTã€ã‚¿ã‚¤ãƒ—ã§è¡Œã„ã€PR ã‚’ãƒ–ãƒ­ãƒƒã‚¯ã—ãªã„ã‚ˆã†ã«ã—ã¦ãã ã•ã„ã€‚

          # Optional: Use sticky comments to make Claude reuse the same comment on subsequent pushes to the same PR
          # use_sticky_comment: true

          # Optional: Customize review based on file types
          # direct_prompt: |
          #   Review this PR focusing on:
          #   - For TypeScript files: Type safety and proper interface usage
          #   - For API endpoints: Security, input validation, and error handling
          #   - For React components: Performance, accessibility, and best practices
          #   - For tests: Coverage, edge cases, and test quality

          # Optional: Different prompts for different authors
          # direct_prompt: |
          #   ${{ github.event.pull_request.author_association == 'FIRST_TIME_CONTRIBUTOR' &&
          #   'Welcome! Please review this PR from a first-time contributor. Be encouraging and provide detailed explanations for any suggestions.' ||
          #   'Please provide a thorough code review focusing on our coding standards and best practices.' }}

          # Optional: Add specific tools for running tests or linting
          allowed_tools: "mcp__github__create_pending_pull_request_review,mcp__github__add_pull_request_review_comment_to_pending_review,mcp__github__submit_pending_pull_request_review,mcp__github__get_pull_request_diffBash(npm run lint),Bash(npm run lint:fix),Bash(npm run format),Bash(npm run check-format)"

          # Optional: Skip review for certain conditions
          # if: |
          #   !contains(github.event.pull_request.title, '[skip-review]') &&
          #   !contains(github.event.pull_request.title, '[WIP]')
